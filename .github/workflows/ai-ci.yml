name: AI-Enhanced CI/CD Demo

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  models: read

jobs:
  test-with-ai:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install pytest jq

    - name: Run tests
      id: test
      run: |
        echo "Running tests..."
        set -o pipefail
        pytest 2>&1 | tee error.log

    - name: Show test log on failure
      if: failure()
      run: |
        echo "‚ùå Tests failed! Here is the error log:"
        cat error.log

    - name: AI Error Summary using GitHub Models
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Sending error log to GitHub AI model..."
        ERROR_LOG=$(cat error.log | jq -Rs .)

        RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -d "{
            \"messages\": [
              {\"role\": \"system\", \"content\": \"You are a DevOps assistant. Summarise CI/CD errors clearly and suggest fixes.\"},
              {\"role\": \"user\", \"content\": $ERROR_LOG}
            ],
            \"model\": \"openai/gpt-4.1-mini\"
          }")

        echo "=== AI Summary ==="
        echo "$RESPONSE"
