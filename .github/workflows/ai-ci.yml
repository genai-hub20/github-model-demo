name: AI-Enhanced CI/CD Demo

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-with-ai:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install pytest

    - name: Run tests
      id: test
      run: |
        echo "Running tests..."
        pytest 2>&1 | tee error.log
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "‚ùå Tests failed! Showing error log:"
          cat error.log
          exit 1
        fi

    - name: AI Error Summary
      if: failure()  # Only run if previous step failed
      env:
        AI_API_KEY: ${{ secrets.GITHUB_MODELS_API_KEY }}
      run: |
        echo "Sending error log to GitHub AI model..."
        ERROR_LOG=$(cat error.log)
        curl https://api.github.com/models/gpt-4.1-mini/inference \
          -H "Authorization: Bearer $AI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"messages\": [
              {
                \"role\": \"system\",
                \"content\": \"You are a DevOps assistant. Summarise CI/CD errors clearly and suggest fixes.\"
              },
              {
                \"role\": \"user\",
                \"content\": \"Here is the CI error log:\\n$ERROR_LOG\"
              }
            ]
          }"
